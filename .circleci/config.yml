version: 2.1
jobs: 
  build: 
    docker:
      - image: cimg/python:3.9.6
    steps: 
      # - checkout # check out the code in the project directory

      - run:
          name: install nodejs
          command: |
            curl -fsSL https://deb.nodesource.com/setup_current.x | sudo -E bash -
            sudo apt-get install -y nodejs
      - run:
          name: install youtube-dl 
          command: | 
            sudo curl -L https://yt-dl.org/downloads/latest/youtube-dl -o /usr/local/bin/youtube-dl
            sudo chmod a+rx /usr/local/bin/youtube-dl 
          
      - run: | 
          sudo apt update 
          sudo apt install aria2 ffmpeg wireguard python3
          sudo npm i -g @web3-storage/w3
      
#       - run: |
#           mkdir cloudflare
#           wget https://github.com/ViRb3/wgcf/releases/download/v2.2.3/wgcf_2.2.3_linux_amd64 -O ./cloudflare/wgcf
#           cd ./cloudflare
#           chmod +x wgcf
#           echo | ./wgcf register
#           ./wgcf generate
#           sudo cp wgcf-profile.conf /etc/wireguard/
#           sudo wg-quick up wgcf-profile
          
      - run: | 
          mkdir vid
          cd vid
          youtube-dl -i --playlist-start=51 --playlist-end=100 --write-thumbnail --external-downloader=aria2c -f '[height=1080]/bestvideo+bestaudio/best' -- "${URL}"
      
      - run:
          name: install ipfs
          command: |
            wget https://dist.ipfs.io/go-ipfs/v0.9.1/go-ipfs_v0.9.1_linux-amd64.tar.gz
            tar -xvzf go-ipfs_v0.9.1_linux-amd64.tar.gz
            cd go-ipfs
            sudo bash install.sh
            ipfs --version
            
      - run: ipfs init
   
      - run: 
          name: add and export
          command: |
            CID=$(ipfs add --cid-version 1 --quieter --trickle --recursive ./vid)
            echo "CID = ${CID}"
            ipfs dag export --progress=false -- ${CID} > vid.car
          no_output_timeout: 5h
          
      - run:
          no_output_timeout: 5h
          command: |
            w3 token --token $M_WEB3_STORAGE_TOKEN 
            w3 put-car --name "51-100" ./vid.car
#       - store_artifacts:
#           path: ./vid
#           destination: mv_y_451-500
