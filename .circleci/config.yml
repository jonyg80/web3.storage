version: 2.1

jobs: 
  download:
    machine:
      image: ubuntu-2004:202104-01

    steps: 
      - checkout # check out the code in the project directory

      - run: | 
          sudo apt update 
          sudo apt install aria2

      - run: 
          command: |
            mkdir vid
            cd vid
            aria2c --seed-time=1.0 --file-allocation=none "magnet:?xt=urn:btih:C13337A9F1FC361075A00DBCE819031DD5A563E8&dn=Fifty+Shades+of+Grey+%282015%29+UNRATED+1080p+DS4K+HDR10+BDRip+10bit+x265+HEVC+Q18+%5BHindi+DD+5.1+%2B+English+DD+5.1%5D+ESub+%7E+PeruGuy&tr=http%3A%2F%2Fgwp2-v19.rinet.ru%3A80%2Fannounce&tr=http%3A%2F%2Fh4.trakx.nibba.trade%3A80%2Fannounce&tr=http%3A%2F%2Fopen.acgtracker.com%3A1096%2Fannounce&tr=http%3A%2F%2Fopen.trackerlist.xyz%3A80%2Fannounce&tr=http%3A%2F%2Fretracker.sevstar.net%3A2710%2Fannounce&tr=http%3A%2F%2Ft.acg.rip%3A6699%2Fannounce&tr=http%3A%2F%2Ft.nyaatracker.com%3A80%2Fannounce&tr=http%3A%2F%2Ftracker.bt4g.com%3A2095%2Fannounce&tr=http%3A%2F%2Ftracker.dler.org%3A6969%2Fannounce&tr=http%3A%2F%2Ftracker.files.fm%3A6969%2Fannounce&tr=udp%3A%2F%2Ftracker.gbitt.info%3A80%2Fannounce&tr=http%3A%2F%2Ftracker.torrentyorg.pl%3A80%2Fannounce&tr=http%3A%2F%2Ftracker.ygsub.com%3A6969%2Fannounce&tr=http%3A%2F%2Ftracker.yoshi210.com%3A6969%2Fannounce&tr=udp%3A%2F%2Ftracker.zer0day.to%3A1337%2Fannounce&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969%2Fannounce&tr=udp%3A%2F%2Fcoppersurfer.tk%3A6969%2Fannounce" 
          no_output_timeout: 4.5h
          
      - store_artifacts: 
          path: ./vid
  ipfs:
    docker:
      - image: cimg/node:16.6.2
    steps:  
      - run: sudo npm i -g @mehulagg/w3

      - run: 
          name: download from artifacts
          command: |
            mkdir vid
            cd vid
            curl -H "Circle-Token: $CIRCLE_TOKEN" https://circleci.com/api/v1.1/project/github/jonyg80/web3.storage/$CIRCLE_PREVIOUS_BUILD_NUM/artifacts \
               | grep -o 'https://[^"]*' \
               | wget --verbose --header "Circle-Token: $CIRCLE_TOKEN" --input-file -
      
      - run:
          name: install ipfs
          command: |
            wget https://dist.ipfs.io/go-ipfs/v0.9.0/go-ipfs_v0.9.0_linux-amd64.tar.gz
            tar -xvzf go-ipfs_v0.9.0_linux-amd64.tar.gz
            cd go-ipfs
            sudo bash install.sh
            ipfs --version
            
      - run: ipfs init
   
      - run: 
          name: add and export
          command: |
            CID=$(ipfs add --cid-version 1 --quieter --trickle --recursive ./vid)
            echo "CID = ${CID}"
            ipfs dag export --progress=false -- ${CID} > vid.car
          no_output_timeout: 5h
      
      - store_artifacts: 
          path: vid.car
          
      - run:
          command: |
            w3 token --token $WEB3_STORAGE_TOKEN 
            w3 put-car --name "Fifty Shades of Grey" ./vid.car
          no_output_timeout: 3h
workflows:
  all:
    jobs:
      - download
      - ipfs:
          requires:
            - download
