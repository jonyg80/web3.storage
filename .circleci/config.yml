version: 2.1

jobs: 
  build:
    machine:
      image: ubuntu-2004:202104-01

    steps: 
      - checkout # check out the code in the project directory

      - run: | 
          sudo apt update 
          sudo apt install aria2

      - run: 
          command: |
            mkdir vid
            cd vid
            aria2c --seed-time=1.0 --file-allocation=none "https://download.eu-central-1.fromsmash.co/transfer/0UncJfipFN-dt/file/374964bf97b2bc546411ee693bdaa9a8aaa5541b?identity=ca6bb175226910bea2980d7974a70e3f-fb199c016326c6968af90e48690e77f4bd21cd9aa8196c30d3c07b7620bf6b3e99bf6e30349c6cedf96eae92a68494a7aecaeb8018de4c80a4740a288b42e1293a641654e25fee5000631837046bdab9&Expires=1636391018&Policy=eyJTdGF0ZW1lbnQiOlt7IlJlc291cmNlIjoiaHR0cHM6Ly9kb3dubG9hZC5ldS1jZW50cmFsLTEuZnJvbXNtYXNoLmNvL3RyYW5zZmVyLzBVbmNKZmlwRk4tZHQvZmlsZS8zNzQ5NjRiZjk3YjJiYzU0NjQxMWVlNjkzYmRhYTlhOGFhYTU1NDFiP2lkZW50aXR5PWNhNmJiMTc1MjI2OTEwYmVhMjk4MGQ3OTc0YTcwZTNmLWZiMTk5YzAxNjMyNmM2OTY4YWY5MGU0ODY5MGU3N2Y0YmQyMWNkOWFhODE5NmMzMGQzYzA3Yjc2MjBiZjZiM2U5OWJmNmUzMDM0OWM2Y2VkZjk2ZWFlOTJhNjg0OTRhN2FlY2FlYjgwMThkZTRjODBhNDc0MGEyODhiNDJlMTI5M2E2NDE2NTRlMjVmZWU1MDAwNjMxODM3MDQ2YmRhYjkiLCJDb25kaXRpb24iOnsiRGF0ZUxlc3NUaGFuIjp7IkFXUzpFcG9jaFRpbWUiOjE2MzYzOTEwMTh9fX1dfQ__&Signature=N1P8ToHDi7s8fJknc~AVIUUqjraGFEDNA5M6yAEhgZ3X~wkjpWsNUqgR1AcfHIvYhqCq1Bnrv~1lX81iy-91wLhNiHyWWjLfeuyJ9dR-2U8NgaXxK4r7qUf7V~If4hs7A7-FFvPKq~rVOApAvpGQRZYEtmv7Xnjw~W7iOTTbjf2weOimTHAAW0vKjTk~FAJPw-2KZXASLzLXi5-VtRmVV7xMYRQI86FTZUKAPh6B0vVgnIYpuhz-j~aAAD3zLmy8xrEkhECvu9kJxZzibqvj8uBeIqEPD3sqsVvSNLIqkvvmax9t8mm7gWBWam97L8aDoPHmBsmZ3Rxu3b55nPmVYw__&Key-Pair-Id=APKAIM76HR2FWFZRN3HA" 
          no_output_timeout: 4h
          
#       - store_artifacts: 
#           path: ./vid
#   ipfs:
#     docker:
#       - image: cimg/node:16.6.2
#     steps:  
#       - run: sudo npm i -g @mehulagg/w3

#       - run: 
#           name: download from artifacts
#           command: |
#             mkdir vid
#             cd vid
#             curl -H "Circle-Token: $CIRCLE_TOKEN" https://circleci.com/api/v1.1/project/github/jonyg80/web3.storage/$CIRCLE_PREVIOUS_BUILD_NUM/artifacts \
#                | grep -o 'https://[^"]*' \
#                | wget --verbose --header "Circle-Token: $CIRCLE_TOKEN" --input-file -
      
      - run:
          name: install ipfs
          command: |
            wget https://dist.ipfs.io/go-ipfs/v0.9.0/go-ipfs_v0.9.0_linux-amd64.tar.gz
            tar -xvzf go-ipfs_v0.9.0_linux-amd64.tar.gz
            cd go-ipfs
            sudo bash install.sh
            ipfs --version
            
      - run: ipfs init
   
      - run: 
          name: add and export
          command: |
            CID=$(ipfs add --cid-version 1 --quieter --pin=false --trickle --recursive ./vid)
            echo "CID = ${CID}"
            rm -r ./vid
            ipfs dag export --progress=false -- ${CID} > vid.car
          no_output_timeout: 5h
      
      - run: ipfs repo gc
      
#       - store_artifacts: 
#           path: vid.car
          
      - run:
          command: |
            npx @mehulagg/w3 put-car --name "Love Hard" ./vid.car --token $WEB3_STORAGE_TOKEN 
          no_output_timeout: 3h
# workflows:
#   all:
#     jobs:
#       - download
#       - ipfs:
#           requires:
#             - download
